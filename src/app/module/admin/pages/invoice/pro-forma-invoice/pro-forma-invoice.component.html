<div class="p-6 sm:p-10 mx-auto bg-gray-50 border border-gray-300 shadow-2xl">
  <header class="mb-8 text-center">
    <h1 class="text-3xl font-bold text-blue-700">PRO FORMA INVOICE CREATOR</h1>
    <p class="text-gray-600 mt-2">
      Step {{ currentStep }} of {{ totalSteps }}:
      <span *ngIf="currentStep === 1">Select Purchase Order</span>
      <span *ngIf="currentStep === 2">Enter Details & Confirm Items</span>
      <span *ngIf="currentStep === 3">Review & Print Invoice</span>
    </p>
    <div class="h-2 bg-gray-200 rounded-full mt-4">
      <div
        class="h-full bg-blue-500 rounded-full transition-all duration-500"
        [style.width]="(currentStep / totalSteps) * 100 + '%'"
      ></div>
    </div>
  </header>

  <form [formGroup]="proFormaForm" class="space-y-8">
    <section *ngIf="currentStep === 1">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">
        Select Incoming Purchase Order
      </h2>
      <div
        *ngIf="isLoading"
        class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 z-10 rounded-lg"
      >
        <div class="text-center">
          <svg
            class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p class="mt-2 text-blue-600 font-medium">Loading PO details...</p>
        </div>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20"
              >
                Action
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                PO Number
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Customer Name
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Date Created
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let po of incomingPOs">
              <td class="px-6 py-4 whitespace-nowrap">
                <button
                  (click)="selectPO(po.id)"
                  [disabled]="isLoading"
                  class="text-blue-600 hover:text-blue-900 font-medium text-sm disabled:text-gray-400 disabled:cursor-not-allowed"
                >
                  {{ isLoading ? "Loading..." : "Select" }}
                </button>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                {{ po.poNumber }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ po.buyerOrgName }}
              </td>
              <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-xs">
                {{ po.createdAt | date }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <p *ngIf="!incomingPOs.length" class="p-6 text-center text-gray-500">
        No incoming POs available for selection.
      </p>
    </section>

    <section *ngIf="currentStep === 2" class="space-y-6">
      <div formGroupName="invoiceDetails" class="space-y-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">
          Invoice and Shipping Details for PO #{{ selectedPO?.poNumber }}
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="col-span-1">
            <label class="block text-sm font-medium text-gray-700"
              >Customer Name <span class="text-red-500">*</span></label
            >
            <select
              formControlName="customerId"
              (change)="onCustomerSelect($event)"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
            >
              <option [value]="null" disabled selected>Select customer</option>
              <option
                *ngFor="let customer of customers"
                [value]="customer.customerId"
              >
                {{ customer.customerName }}
              </option>
            </select>
          </div>

          <div class="col-span-1">
            <label class="block text-sm font-medium text-gray-700"
              >Pro Forma Invoice # <span class="text-red-500">*</span></label
            >
            <input
              type="text"
              formControlName="invoiceNumber"
              placeholder="FM-PI-XXXX-XXXXX"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
            />
          </div>
          <div class="col-span-1">
            <label class="block text-sm font-medium text-gray-700">Date</label>
            <input
              type="date"
              formControlName="date"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
            />
          </div>

          <div class="col-span-1 md:col-span-3">
            <label class="block text-sm font-medium text-gray-700"
              >Currency</label
            >
            <select
              formControlName="currency"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
            >
              <option value="USD">USD - US Dollar</option>
              <option value="EUR">EUR - Euro</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Customer (Bill To) Address
              <span class="text-red-500">*</span></label
            >
            <textarea
              formControlName="customerAddress"
              rows="4"
              placeholder="Enter Full Customer Address"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Ship To Address <span class="text-red-500">*</span></label
            >
            <textarea
              formControlName="shipToAddress"
              rows="4"
              placeholder="Enter Full Shipping Address"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
            ></textarea>
          </div>
        </div>

        <h3 class="text-lg font-semibold mt-6 text-gray-700 border-t pt-4">
          Shipping Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Freight Type <span class="text-red-500">*</span></label
            >
            <select
              formControlName="freightType"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
            >
              <option value="PICK UP">PICK UP</option>
              <option value="EX WORKS">EX WORKS</option>
              <option value="FOB">FOB</option>
              <option value="CIF">CIF</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Estimated Ship Date</label
            >
            <input
              type="text"
              formControlName="estimatedShipDate"
              placeholder="N/A or DD-Mon-YY"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
            />
          </div>
        </div>
      </div>
      <h3 class="text-lg font-semibold mt-6 text-gray-700 border-t pt-4">
        Line Items (Confirm/Adjust)
      </h3>
      <div class="overflow-x-auto bg-white border border-gray-300 rounded-lg">
        <table class="min-w-full text-xs">
          <thead class="bg-gray-200">
            <tr>
              <th class="py-2 px-3 text-left">Part #</th>
              <th class="py-2 px-3 text-left">Description</th>
              <th class="py-2 px-3 text-center w-24">QTY</th>
              <th class="py-2 px-3 text-right w-32">Unit Price</th>
              <th class="py-2 px-3 text-right w-32">E-Price</th>
            </tr>
          </thead>
          <tbody formArrayName="lineItems">
            <tr
              *ngFor="let itemGroup of itemsArray.controls; let i = index"
              [formGroupName]="i"
              class="border-t"
            >
              <td class="py-2 px-3">
                <input
                  type="text"
                  formControlName="partNumber"
                  class="w-full bg-transparent border-none p-0"
                />
              </td>
              <td class="py-2 px-3">
                <textarea
                  formControlName="description"
                  rows="2"
                  class="w-full border-gray-200 rounded-md p-1 text-xs"
                ></textarea>
              </td>
              <td class="py-2 px-3">
                <input
                  type="number"
                  formControlName="quantity"
                  (change)="calculateExtendedPrice(itemGroup)"
                  class="w-full text-center border-gray-200 rounded-md p-1"
                />
              </td>
              <td class="py-2 px-3">
                <input
                  type="number"
                  formControlName="unitPrice"
                  (change)="calculateExtendedPrice(itemGroup)"
                  class="w-full text-right border-gray-200 rounded-md p-1"
                />
              </td>
              <td class="py-2 px-3 text-right font-semibold text-gray-800">
                {{
                  (itemGroup.get("extendedPrice")?.value
                    | currency
                      : proFormaForm.get("invoiceDetails")?.get("currency")
                          ?.value
                      : "symbol"
                      : "1.2-2") || "0.00"
                }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    <section *ngIf="currentStep === 3" class="space-y-6">
      <div *ngIf="finalInvoiceData">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">
          Final Pro Forma Invoice Review
        </h2>

        <div
          class="p-4 sm:p-8 max-w-5xl mx-auto bg-white border border-gray-700 print:shadow-none print:border-0 text-gray-800"
        >
          <header
            class="flex justify-between items-start pb-4 border-b border-gray-700 mb-4 print:border-b-black"
          >
            <div class="text-left">
              <h1 class="text-xl font-bold text-blue-700 uppercase">
                {{ seller.name }}
              </h1>
              <p class="text-xs text-gray-600">{{ seller.address }}</p>
            </div>
            <div class="text-right">
              <h2
                class="text-2xl font-extrabold text-red-600 uppercase tracking-widest"
              >
                PRO FORMA INVOICE
              </h2>
            </div>
          </header>

          <section
            class="grid grid-cols-3 gap-0 border border-gray-700 print:border-black"
          >
            <div
              class="col-span-1 p-3 border-r border-gray-700 print:border-r-black"
            >
              <h3
                class="text-xs font-bold bg-gray-200 p-1 border-b border-gray-700 print:bg-gray-300 print:border-b-black"
              >
                SELLER / SHIP FROM
              </h3>
              <strong class="text-xs block mt-1">{{ seller.name }}</strong>
              <p class="text-xs mt-1">{{ seller.address }}</p>
              <p class="text-xs mt-1">Phone: {{ seller.phone }}</p>
              <p class="text-xs">Fax: {{ seller.fax }}</p>
            </div>
            <div
              class="col-span-1 p-3 border-r border-gray-700 print:border-r-black whitespace-pre-wrap"
            >
              <h3
                class="text-xs font-bold bg-gray-200 p-1 border-b border-gray-700 print:bg-gray-300 print:border-b-black"
              >
                CUSTOMER (BILL TO)
              </h3>
              <strong class="text-xs block mt-1">{{
                finalInvoiceData.customerAddress
              }}</strong>
              <h3
                class="text-xs font-bold bg-gray-200 p-1 border-b border-gray-700 print:bg-gray-300 print:border-b-black mt-2"
              >
                SHIP TO
              </h3>
              <p class="text-xs mt-1">{{ finalInvoiceData.shipToAddress }}</p>
            </div>
            <div class="col-span-1 p-0 text-xs">
              <div class="border-b border-gray-700 flex print:border-b-black">
                <div
                  class="w-1/2 p-2 font-bold bg-gray-100 border-r border-gray-700 print:border-r-black"
                >
                  INVOICE #
                </div>
                <div class="w-1/2 p-2 font-bold text-blue-800">
                  {{ finalInvoiceData.invoiceNumber }}
                </div>
              </div>
              <div class="border-b border-gray-700 flex print:border-b-black">
                <div
                  class="w-1/2 p-2 font-bold bg-gray-100 border-r border-gray-700 print:border-r-black"
                >
                  DATE
                </div>
                <div class="w-1/2 p-2">{{ finalInvoiceData.date }}</div>
              </div>
              <div class="border-b border-gray-700 flex print:border-b-black">
                <div
                  class="w-1/2 p-2 font-bold bg-gray-100 border-r border-gray-700 print:border-r-black"
                >
                  CUSTOMER PO #
                </div>
                <div class="w-1/2 p-2 font-bold text-red-700">
                  {{ finalInvoiceData.poNumber }}
                </div>
              </div>
              <div class="border-b border-gray-700 flex print:border-b-black">
                <div
                  class="w-1/2 p-2 font-bold bg-gray-100 border-r border-gray-700 print:border-r-black"
                >
                  FREIGHT TYPE
                </div>
                <div class="w-1/2 p-2">{{ finalInvoiceData.freightType }}</div>
              </div>
              <div class="flex">
                <div
                  class="w-1/2 p-2 font-bold bg-gray-100 border-r border-gray-700 print:border-r-black"
                >
                  EST. SHIP DATE
                </div>
                <div class="w-1/2 p-2">
                  {{ finalInvoiceData.estimatedShipDate }}
                </div>
              </div>
            </div>
          </section>

          <section class="line-items mt-6">
            <div
              class="overflow-x-auto border border-gray-700 print:border-black"
            >
              <table class="min-w-full text-xs bg-white border-collapse">
                <thead class="bg-gray-200 print:bg-gray-300">
                  <tr class="border-b border-gray-700 print:border-b-black">
                    <th
                      class="py-2 px-1 text-center font-bold border-r border-gray-700 print:border-r-black w-[5%]"
                    >
                      LN#
                    </th>
                    <th
                      class="py-2 px-3 text-left font-bold border-r border-gray-700 print:border-r-black w-[15%]"
                    >
                      PART NUMBER
                    </th>
                    <th
                      class="py-2 px-1 text-center font-bold border-r border-gray-700 print:border-r-black w-[5%]"
                    >
                      UI
                    </th>
                    <th
                      class="py-2 px-3 text-left font-bold border-r border-gray-700 print:border-r-black w-[50%]"
                    >
                      DESCRIPTION
                    </th>
                    <th
                      class="py-2 px-1 text-center font-bold border-r border-gray-700 print:border-r-black w-[5%]"
                    >
                      QTY
                    </th>
                    <th
                      class="py-2 px-3 text-right font-bold border-r border-gray-700 print:border-r-black w-[10%] whitespace-nowrap"
                    >
                      UNIT PRICE
                    </th>
                    <th
                      class="py-2 px-3 text-right font-bold w-[10%] whitespace-nowrap"
                    >
                      E-PRICE
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let item of finalInvoiceData.items; let i = index"
                    class="border-b border-gray-300"
                  >
                    <td
                      class="py-2 px-1 text-center border-r border-gray-700 print:border-r-black"
                    >
                      {{ i + 1 }}
                    </td>
                    <td
                      class="py-2 px-3 text-left border-r border-gray-700 print:border-r-black font-mono text-gray-700"
                    >
                      {{ item.partNumber }}
                    </td>
                    <td
                      class="py-2 px-1 text-center border-r border-gray-700 print:border-r-black"
                    >
                      {{ item.unitOfIssue }}
                    </td>
                    <td
                      class="py-2 px-3 text-left border-r border-gray-700 print:border-r-black"
                    >
                      {{ item.description }}
                    </td>
                    <td
                      class="py-2 px-1 text-center border-r border-gray-700 print:border-r-black"
                    >
                      {{ item.quantity }}
                    </td>
                    <td
                      class="py-2 px-3 text-right border-r border-gray-700 print:border-r-black whitespace-nowrap"
                    >
                      {{
                        item.unitPrice
                          | currency
                            : finalInvoiceData.totals.currency
                            : "symbol"
                            : "1.2-2"
                      }}
                    </td>
                    <td
                      class="py-2 px-3 text-right font-semibold text-gray-800 whitespace-nowrap"
                    >
                      {{
                        item.quantity * item.unitPrice
                          | currency
                            : finalInvoiceData.totals.currency
                            : "symbol"
                            : "1.2-2"
                      }}
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr
                    class="bg-gray-100 border-t-2 border-gray-700 print:border-t-black"
                  >
                    <td
                      colspan="6"
                      class="py-2 px-3 text-right font-bold text-sm border-r border-gray-700 print:border-r-black uppercase"
                    >
                      TOTAL ({{ finalInvoiceData.totals.currency }}):
                    </td>
                    <td
                      class="py-2 px-3 text-right font-extrabold text-base text-blue-700 whitespace-nowrap"
                    >
                      {{
                        finalInvoiceData.totals.total
                          | currency
                            : finalInvoiceData.totals.currency
                            : "symbol"
                            : "1.2-2"
                      }}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </section>

          <p class="text-xs italic text-gray-600 mt-6">
            **This is a Pro Forma Invoice, not a tax invoice. It is provided for
            customs and payment purposes against your Purchase Order (PO) #{{
              finalInvoiceData.poNumber
            }}.**
          </p>

          <div class="float-right text-sm text-gray-800 text-center mt-8">
            <div
              class="border-t border-gray-500 mt-1 pt-1 print:border-t-black"
            >
              <p class="font-semibold">TOM JOSEPH</p>
            </div>
            <p class="text-xs italic">Date: {{ finalInvoiceData.date }}</p>
          </div>
          <div class="clearfix"></div>
        </div>
      </div>
      <div
        *ngIf="!finalInvoiceData"
        class="p-6 text-center text-red-500 border border-red-200 bg-red-50 rounded-lg"
      >
        Error: Invoice data could not be generated. Please go back to Step 2 and
        ensure all fields are valid.
      </div>
    </section>

    <div class="flex justify-between pt-6 border-t border-gray-300">
      <button
        type="button"
        (click)="prevStep()"
        [disabled]="currentStep === 1"
        class="px-6 py-2 bg-gray-400 text-white font-semibold rounded-md shadow-md hover:bg-gray-500 disabled:opacity-50 transition duration-150"
      >
        &larr; Previous
      </button>

      <button
        *ngIf="currentStep === 2"
        type="button"
        (click)="generateInvoice()"
        [disabled]="proFormaForm.invalid"
        class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 disabled:opacity-50 transition duration-150"
      >
        Review & Generate Invoice &rarr;
      </button>

      <button
        *ngIf="currentStep === 3"
        type="button"
        (click)="prevStep()"
        class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 transition duration-150 print:hidden"
      >
        Edit Details
      </button>

      <button
        *ngIf="currentStep === 3"
        type="button"
        onclick="window.print()"
        class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 transition duration-150 print:hidden"
      >
        Print Final Invoice
      </button>
    </div>
  </form>
</div>
